<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Tx.RV</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="application-name" content="Tx.RV">
  <meta name="theme-color" content=var(--bgColor)>
  <meta name="description" content="Tx.RV">
  <meta name="keywords" content="縦書きテキストリーダー">
  <link rel="icon" href="img/logo.svg" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="img/ios_logo.png" />

  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #f4f4f4;
      font-family: serif;
      -webkit-tap-highlight-color: transparent;
    }

    .viewer-container {
      width: 100vw;
      height: 100vh;
      writing-mode: vertical-rl;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      overflow-wrap: break-word;
      text-align: justify;
    }

    .viewer-container::-webkit-scrollbar {
      display: none;
    }

    .text-content {
      height: 90vh;
      padding: 5vh 0;
      column-width: 85vw;
      column-gap: 1.5em;
      font-size: 1.2rem;
      letter-spacing: 0.1em;
      line-height: 1.8;
      line-break: auto;
      scroll-snap-align: start;
      color: #777;
      white-space: pre-wrap;
      position: relative;
      z-index: 1;
    }

    .controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.8);
      border-top: 0px solid #ccc;
      padding: 10px 15px;
      box-sizing: border-box;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-size: 14px;
      font-family: "Helvetica", "serif";
      z-index: 10;
      transition: transform 0.3s ease-in-out;
      border-radius: 1em 1em 0em 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .controls.hidden {
      transform: translateY(100%);
    }

    .controls>div {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .controls input[type="range"] {
      width: 100px;
    }

    /*select,
    ::picker(select) {
      appearance: base-select;
      border: 0;
      border-bottom: 1px solid;
      border-radius: 0;
    } */

    .progress-bar-container {
      width: 100%;
      order: -1;
      padding-bottom: 5px;
    }

    #progressBar {
      width: 100%;
      margin: 0;
      pointer-events: none;
      /* 表示専用 */
    }

    .ui-toggle-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 11;
      width: 40px;
      height: 40px;
      font-size: 20px;
      color: #aaa;
      background: rgba(255, 255, 255, 0.8);
      border: 0px solid #ccc;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    label {
      display: block;
      white-space: nowrap;
    }

    /* WebKit (Chrome, Safari, Edge) のサム */
    input.progressbar[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
    }

    /* Mozilla (Firefox) のサム */
    input.progressbar[type="range"]::-moz-range-thumb {
      appearance: none;
      display: none;
    }

    input.commonbar[type="range"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      width: 100%;
      height: 25px;
      margin: 10px 0;
      background: transparent;
      cursor: pointer;
    }

    /* WebKit (Chrome, Safari, Edge) のトラック */
    input.commonbar[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 8px;
      background: rgba(240, 240, 240, 0.6);
      border-radius: 4px;
      border: none;
    }

    /* Mozilla (Firefox) のトラック */
    input.commonbar[type="range"]::-moz-range-track {
      width: 100%;
      height: 8px;
      background: rgba(240, 240, 240, 0.6);
      border-radius: 4px;
      border: none;
    }

    /* WebKit (Chrome, Safari, Edge) のサム */
    input.commonbar[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      margin-top: -8.5px;
      height: 25px;
      width: 12px;
      background: #ccc;
      border-radius: 20%;
      border: 1px solid #fff;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      transition: background 0.2s;
    }

    /* Mozilla (Firefox) のサム */
    input.commonbar[type="range"]::-moz-range-thumb {
      appearance: none;
      height: 25px;
      width: 12px;
      background: #ccc;
      border-radius: 20%;
      border: 1px solid #fff;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      transition: background 0.2s;
    }

    /* ホバー・アクティブ時のスタイル */
    /* WebKit/Blink (Chrome, Safari, Edge) */
    input.commonbar[type="range"]:hover::-webkit-slider-thumb,
    input.commonbar[type="range"]:active::-webkit-slider-thumb {
      background: #ddd;
    }

    /* Mozilla (Firefox) */
    input.commonbar[type="range"]:hover::-moz-range-thumb,
    input.commonbar[type="range"]:active::-moz-range-thumb {
      background: #ddd;
    }

    /* フォーカス時のスタイル (全ブラウザ共通) */
    input.commonbar[type="range"]:focus {
      outline: none;
    }

    input.commonbar[type="range"]:focus::-webkit-slider-runnable-track {
      box-shadow: 0 0 0 2px #cce5ff;
    }

    input.commonbar[type="range"]:focus::-moz-range-track {
      box-shadow: 0 0 0 2px #cce5ff;
    }
  </style>
</head>

<body>

  <button class="ui-toggle-btn" id="uiToggleBtn">・</button>

  <div class="controls" id="controlsPanel">
    <div class="progress-bar-container">
      <input type="range" class="progressbar" id="progressBar" min="0" max="100" step="0.1" value="0">
    </div>
    <div>
      <label for="fileInput">ファイル：</label>
      <input type="file" id="fileInput" accept=".txt">
    </div>
    <div>
      <label for="encodingSelect">文字コード：</label>
      <select id="encodingSelect">
        <option value="shift_jis" selected>Shift_JIS</option>
        <option value="utf-8">UTF-8</option>
        <option value="euc-jp">EUC-JP</option>
      </select>
    </div>
    <hr style="width:100%; margin: 2px 0; border: none; border-top: 1px dashed #ccc;">
    <div>
      <label for="fontSize">文字：</label>
      <input type="range" id="fontSize" class="commonbar" min="0.8" max="3" step="0.1" value="1.2">
    </div>
    <div style="display: none;">
      <label for="columnGap">ページ間：</label>
      <input type="range" id="columnGap" class="commonbar" min="0.5" max="5" step="0.1" value="1.5">
    </div>
    <div>
      <label for="letterSpacing">文字間：</label>
      <input type="range" id="letterSpacing" class="commonbar" min="0" max="1" step="0.05" value="0.1">
    </div>
    <div>
      <label for="lineHeight">行幅：</label>
      <input type="range" id="lineHeight" class="commonbar" min="1.2" max="3" step="0.1" value="1.8">
    </div>
    <div>
      <label for="flipWidth">めくり量：</label>
      <input type="range" id="flipWidth" class="commonbar" min="0.01" max="1.00" step="0.01" value="0.95" oninput="flipWidth_display.value = flipWidth.value">
<output for="flipWidth" id="flipWidth_display">0.95</output>
    </div>
    <div>
      <label for="fontFamily">フォント：</label>
      <select id="fontFamily">
        <option value="serif">明朝体</option>
        <option value="Zen Old Mincho">Zen Old Mincho</option>
        <option value="sans-serif">ゴシック体</option>
      </select>
    </div>
    <div>
      <input type="checkbox" id="swapTap">
      <label for="swapTap">タップ左右入替</label>
    </div>
  </div>

  <div class="viewer-container" id="viewerContainer">
    <div class="text-content" id="textContent">
      　ようこそ、ここはTxシリーズの縦書き表示用テキストファイルビューワーである「Tx.RV」です。下のツールバーから、読みたいテキストファイルを選択してください。
      　文字化けしてしまう際は、エンコードを変更してみてください。
      　
      　JavaScriptの制作には生成AIを使用しています。デザインや動作確認、JavaScriptのエラー修正などは手作業で行なっています。
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- DOM取得 ---
      const textContent = document.getElementById('textContent');
      const viewerContainer = document.getElementById('viewerContainer');
      const controlsPanel = document.getElementById('controlsPanel');
      const uiToggleBtn = document.getElementById('uiToggleBtn');
      const fileInput = document.getElementById('fileInput');
      const encodingSelect = document.getElementById('encodingSelect');
      const swapTapCheckbox = document.getElementById('swapTap');
      const fontSizeSlider = document.getElementById('fontSize');
      const columnGapSlider = document.getElementById('columnGap');
      const letterSpacingSlider = document.getElementById('letterSpacing');
      const lineHeightSlider = document.getElementById('lineHeight');
      const fontFamilySelect = document.getElementById('fontFamily');
      const progressBar = document.getElementById('progressBar');
      const flipWidth = document.getElementById('flipWidth');
      // --- プログレスバー ---
      function updateProgress() {
        const container = viewerContainer;
        const scrollableWidth = container.scrollWidth - container.clientWidth;
        if (scrollableWidth <= 0) {
          progressBar.value = 0;
          return;
        }
        const progress = (Math.abs(container.scrollLeft) / scrollableWidth) * 100;
        progressBar.value = Math.max(0, Math.min(100, progress));
      }
      viewerContainer.addEventListener('scroll', updateProgress);
      // --- ファイル読み込み ---
      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const selectedEncoding = encodingSelect.value;
        textContent.textContent = `読み込み中... (${selectedEncoding})`;
        textContent.style.color = '#777';
        const reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = (e) => {
          try {
            const buffer = e.target.result;
            const decoder = new TextDecoder(selectedEncoding);
            const text = decoder.decode(buffer);
            textContent.textContent = text;
            textContent.style.color = '#333';
            viewerContainer.scrollLeft = 0;
            progressBar.value = 0;
            setTimeout(updateProgress, 100);
          } catch (err) {
            textContent.textContent = `エラー: [${selectedEncoding}] でデコード失敗。`;
            textContent.style.color = '#c00';
          }
        };
      });
      // --- 設定UI ---
      fontSizeSlider.addEventListener('input', (e) => {
        textContent.style.fontSize = e.target.value + 'rem';
      });
      columnGapSlider.addEventListener('input', (e) => {
        textContent.style.columnGap = e.target.value + 'em';
      });
      letterSpacingSlider.addEventListener('input', (e) => {
        textContent.style.letterSpacing = e.target.value + 'em';
      });
      lineHeightSlider.addEventListener('input', (e) => {
        textContent.style.lineHeight = e.target.value;
      });
      fontFamilySelect.addEventListener('input', (e) => {
        textContent.style.fontFamily = e.target.value;
      });
      // --- トグル ---
      uiToggleBtn.addEventListener('click', () => {
        controlsPanel.classList.toggle('hidden');
        uiToggleBtn.textContent = controlsPanel.classList.contains('hidden') ? '●' : '・';
      });
      // --- タップ・スクロール判別機能 ---
      // ★[修正] turnPage 関数 (v13)
      // iPad Safari のスクロールバグ ( +/- の意味が逆) と
      // v12の端チェックバグを修正
      function turnPage(direction) { // 'next' または 'prev'
        const isSwapped = swapTapCheckbox.checked;
        let actualDirection = direction;
        if (isSwapped) {
          actualDirection = (direction === 'next') ? 'prev' : 'next';
        }
        const container = viewerContainer;
        const currentScroll = container.scrollLeft;
        const maxScroll = container.scrollWidth - container.clientWidth;
        const errorMargin = 5;
        const pageWidth = container.clientWidth * flipWidth.value;
        let newScrollLeft;
        // iPad Safari の挙動 ( +/- の意味が逆) に合わせる
        if (actualDirection === 'next') {
          // 「進む」 (Safariでは scrollLeft を減らす)
          // ★修正：既に「先頭」(0) にいるなら、これ以上「進めない」(減らせない)
          if (currentScroll >= errorMargin) return;
          newScrollLeft = currentScroll - pageWidth;
        } else {
          // 「戻る」 (Safariでは scrollLeft を増やす)
          // ★修正：既に「末尾」(maxScroll) にいるなら、これ以上「戻れない」(増やせない)
          if (currentScroll >= (maxScroll - errorMargin)) return;
          newScrollLeft = currentScroll + pageWidth;
        }
        container.scrollLeft = newScrollLeft;
      }
      // タップ判別ロジック
      let touchStartTime = 0;
      let touchStartScrollLeft = 0;
      let touchStartClientX = 0;
      const MAX_TAP_DURATION = 300;
      const MAX_TAP_MOVE_X = 15;
      const MAX_TAP_SCROLL = 10;

      function handleTouchStart(e) {
        touchStartTime = Date.now();
        touchStartScrollLeft = viewerContainer.scrollLeft;
        touchStartClientX = (e.touches ? e.touches[0] : e).clientX;
      }

      function handleTouchEnd(e) {
        const touchEndTime = Date.now();
        const touchEndClientX = (e.changedTouches ? e.changedTouches[0] : e).clientX;
        const duration = touchEndTime - touchStartTime;
        const deltaX = Math.abs(touchEndClientX - touchStartClientX);
        const deltaScroll = Math.abs(viewerContainer.scrollLeft - touchStartScrollLeft);
        if (
          duration < MAX_TAP_DURATION &&
          deltaX < MAX_TAP_MOVE_X &&
          deltaScroll < MAX_TAP_SCROLL
        ) {
          const screenWidth = window.innerWidth;
          // デフォルト: 左タップ = 'next' (進む), 右タップ = 'prev' (戻る)
          if (touchEndClientX < screenWidth * 0.4) {
            // 左タップ (進む)
            turnPage('next');
          } else if (touchEndClientX > screenWidth * 0.6) {
            // 右タップ (戻る)
            turnPage('prev');
          }
        }
      }
      // イベントリスナー登録
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      if (isTouchDevice) {
        viewerContainer.addEventListener('touchstart', handleTouchStart, {
          passive: true
        });
        viewerContainer.addEventListener('touchend', handleTouchEnd);
      } else {
        viewerContainer.addEventListener('mousedown', handleTouchStart);
        viewerContainer.addEventListener('mouseup', handleTouchEnd);
      }
    });
  </script>

</body>

</html>
